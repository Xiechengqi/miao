<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miao Control Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        .container {
            max-width: 800px;
        }
        .card {
            margin-bottom: 1.5rem;
        }
        #config-display {
            max-height: 500px;
            overflow-y: auto;
            background-color: #212529;
        }
        .btn-group .btn {
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">Miao Control Panel</h1>
        </header>

        <div id="status-alert" class="alert" role="alert" style="display: none;"></div>

        <div class="card">
            <div class="card-header">Process Control</div>
            <div class="card-body btn-group">
                <button id="start-btn" class="btn btn-success">Start</button>
                <button id="stop-btn" class="btn btn-danger">Stop</button>
                <button id="restart-btn" class="btn btn-warning">Restart</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Configuration Management</div>
            <div class="card-body btn-group">
                <button id="gen-config-btn" class="btn btn-primary">Generate Config</button>
                <button id="gen-rule-btn" class="btn btn-primary">Generate Rule</button>
                <button id="show-config-btn" class="btn btn-info">Show Current Config</button>
            </div>
        </div>

        <div class="card" id="config-card" style="display: none;">
            <div class="card-header">
                Current sing-box Config
            </div>
            <div class="card-body">
                <pre id="config-display"><code></code></pre>
            </div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const restartBtn = document.getElementById('restart-btn');
        const genConfigBtn = document.getElementById('gen-config-btn');
        const genRuleBtn = document.getElementById('gen-rule-btn');
        const showConfigBtn = document.getElementById('show-config-btn');
        const configCard = document.getElementById('config-card');
        const configDisplay = document.getElementById('config-display').querySelector('code');
        const statusAlert = document.getElementById('status-alert');

        function showAlert(message, type = 'success') {
            statusAlert.textContent = message;
            statusAlert.className = `alert alert-${type}`;
            statusAlert.style.display = 'block';
            setTimeout(() => {
                statusAlert.style.display = 'none';
            }, 5000);
        }

        async function apiCall(endpoint, method = 'POST', showSuccess = true) {
            try {
                const response = await fetch(`/api/${endpoint}`, { method });
                const text = await response.text();
                if (!response.ok) {
                    throw new Error(`[${response.status}] ${text}`);
                }
                if (showSuccess) {
                    showAlert(`Successfully executed: ${endpoint}`, 'success');
                }
                return text;
            } catch (error) {
                showAlert(`Error: ${error.message}`, 'danger');
                return null;
            }
        }

        startBtn.addEventListener('click', () => apiCall('sing/start'));
        stopBtn.addEventListener('click', () => apiCall('sing/stop'));
        restartBtn.addEventListener('click', () => apiCall('sing/restart'));
        genConfigBtn.addEventListener('click', () => apiCall('config/generate', 'GET'));
        genRuleBtn.addEventListener('click', () => apiCall('rule/generate', 'GET'));

        showConfigBtn.addEventListener('click', async () => {
            const data = await apiCall('config', 'GET', false);
            if (data) {
                try {
                    const jsonData = JSON.parse(data);
                    configDisplay.textContent = jsonData.config_content;
                    configCard.style.display = 'block';
                    showAlert('Configuration loaded.', 'info');
                } catch (e) {
                    showAlert('Failed to parse configuration JSON.', 'danger');
                }
            }
        });
    </script>
</body>
</html>
